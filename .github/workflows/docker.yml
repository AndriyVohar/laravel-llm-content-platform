#name: Docker CI/CD
#
#on:
#  push:
#    branches: [ main, develop ]
#  pull_request:
#    branches: [ main, develop ]
#
#jobs:
#  test:
#    runs-on: ubuntu-latest
#
#    services:
#      postgres:
#        image: postgres:16-alpine
#        env:
#          POSTGRES_DB: laravel_test
#          POSTGRES_USER: laravel
#          POSTGRES_PASSWORD: secret
#        options: >-
#          --health-cmd pg_isready
#          --health-interval 10s
#          --health-timeout 5s
#          --health-retries 5
#        ports:
#          - 5432:5432
#
#    steps:
#    - uses: actions/checkout@v4
#
#    - name: Setup PHP
#      uses: shivammathur/setup-php@v2
#      with:
#        php-version: '8.2'
#        extensions: pdo, pgsql, mbstring, zip, exif, pcntl, bcmath
#        coverage: none
#
#    - name: Copy .env
#      run: cp .env.docker .env
#
#    - name: Install Composer Dependencies
#      run: composer install --no-interaction --prefer-dist --optimize-autoloader
#
#    - name: Generate Application Key
#      run: php artisan key:generate
#
#    - name: Run Migrations
#      env:
#        DB_CONNECTION: pgsql
#        DB_HOST: localhost
#        DB_PORT: 5432
#        DB_DATABASE: laravel_test
#        DB_USERNAME: laravel
#        DB_PASSWORD: secret
#      run: php artisan migrate --force
#
#    - name: Run Tests
#      env:
#        DB_CONNECTION: pgsql
#        DB_HOST: localhost
#        DB_PORT: 5432
#        DB_DATABASE: laravel_test
#        DB_USERNAME: laravel
#        DB_PASSWORD: secret
#      run: php artisan test
#
#    - name: Run Code Style Check
#      run: ./vendor/bin/pint --test
#
#  build:
#    runs-on: ubuntu-latest
#    needs: test
#    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#
#    steps:
#    - uses: actions/checkout@v4
#
#    - name: Set up Docker Buildx
#      uses: docker/setup-buildx-action@v3
#
#    - name: Login to Docker Hub
#      uses: docker/login-action@v3
#      with:
#        username: ${{ secrets.DOCKER_USERNAME }}
#        password: ${{ secrets.DOCKER_PASSWORD }}
#
#    - name: Build and Push Docker Image
#      uses: docker/build-push-action@v5
#      with:
#        context: .
#        target: production
#        push: true
#        tags: |
#          ${{ secrets.DOCKER_USERNAME }}/laravel-llm-platform:latest
#          ${{ secrets.DOCKER_USERNAME }}/laravel-llm-platform:${{ github.sha }}
#        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/laravel-llm-platform:buildcache
#        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/laravel-llm-platform:buildcache,mode=max

